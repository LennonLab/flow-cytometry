---
title: "Flow Cytometry Pipeline for Active, Dormant, and Dead Microbial Populations"
author: "M.L. Larsen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
output: pdf_document
fontsize: 11pt
geometry: margin = 0.75in
---

#Overview

Something about microbial processes... and the type of data collected

#Aims

#Document workflow

#Output figures, tables, and processed files

___

#Data Collection

#Data Processing
#1. R Version and Package information

Source code used in this workflow were provided by X, Y University. 

```{r, echo=FALSE}
# Setup working environment
rm(list = ls())
setwd("C:/Users/Megan/Github/flow-cytometry/")

# Load source code and dependances
## for installation of bioconductor packages
source("http://bioconductor.org/biocLite.R")

## 
source("./bin/flowPrep.R") 

##
source("./bin/support_functions.R")

# Install bioconductor packages. This process will take a bit of time, so be patient.
#biocLite(c("flowPeaks","flowCore","flowStats","flowViz",
#           "flowClust","flowQ", "flowUtils","flowMeans","flowDensity"))
#biocLite("GEOmap");biocLite("Logicle")
#biocLite("flowQ")

# Load bioconductor and stats packages
library(flowPeaks)  
library(flowCore)   
library(flowStats)  
library(flowViz)    
library(flowQ)      
library(flowClust)  
library(flowUtils)  
library(flowMeans) 
library(flowDensity)
library(GEOmap)     
#library(Logicle)
```

All analyses were completed with `r sessionInfo()$R.version$version.string` and the following packages: *ADD TABLE OF PACKAGES, VERSIONS, AND DESCRIPTIONS*

```{r,echo=FALSE}
packinfo <- installed.packages(fields = c("Package","Version"))
packinfo["vegan",c("Package","Version")]
packinfo["vegan",c("Package","Version")]
packinfo["vegan",c("Package","Version")]
packinfo["vegan",c("Package","Version")]
packinfo["vegan",c("Package","Version")]
packinfo["vegan",c("Package","Version")]
```


## 1. Load data
The data for this project were collected in the IU Flow Cytometry Core Facility (C. Hassel) using eFluor fixed viability dye, Hoescht 33342, and Pyronin Y. 
```{r, echo=FALSE, results='hide'}
# Import data
## This set includes all the single color controls
fs.controls <- read.flowSet(path = 'S:/FlowCytometry-INPonds/bch061815-controls', pattern = ".fcs")
fs.controls

fs.bch1 <- read.flowSet(path = 'S:/FlowCytometry-INPonds/bch061815-1', pattern = ".fcs")
fs.bch2 <- read.flowSet(path = 'S:/FlowCytometry-INPonds/bch061815-2', pattern = ".fcs")
fs.bch3 <- read.flowSet(path = 'S:/FlowCytometry-INPonds/bch061815-3', pattern = ".fcs")
```

Due to the size, the data are batched:
  1. *fs.controls* `r sampleNames(fs.controls)`
  2. *fs.bch1* `r sampleNames(fs.bch1)`
  3. *fs.bch2* `r sampleNames(fs.bch2)`
  4. *fs.bch3* `r sampleNames(fs.bch3)`

#2. Diagnostics with control data
## 2.1 Initial Visualization
```{r}
sampleNames(fs.controls)
length(fs.controls)

nrow(fs.controls[[1]])
fsApply(fs.controls,nrow)

fsApply(fs.controls, function(f) f@description$"TUBE NAME")

colnames(fs.controls)

```

Evaluating the control data can help establish the need for data transformation. Good even, flow through the machine (Figure 1) shows that the instrument is running smoothely. The **E. coli standards** in our control batch 

```{r,echo=FALSE}
plot(fs.controls[[6]], 
     c("Time", "SSC-A"), 
     xlim = c(0,10000), 
     #ylim = c(0,5000), 
     smooth = FALSE)
```



```{r,echo=FALSE,results='hide', fig.height=5,fig.width=5}
par(mfrow = c(2,2))

par(mar = c(5,6,4,1))
plot(fs.controls[[6]][1:10000,], 
     c("FSC PMT-A", "SSC-A"), 
     xlim = c(0,50000), 
     ylim = c(0,50000), 
     las =1,
     main = "unstained E. coli",
     smooth = FALSE)
text(0,50000,"A", col = "black",bg = "white")

plot(fs.controls[[7]][1:10000,], 
     c("FSC PMT-A", "SSC-A"), 
     xlim = c(0,50000), 
     ylim = c(0,50000), 
     las = 1,
     main = "Double (H/Py) stained E. coli",
     smooth = FALSE)

par(mar = c(5,6,2,1))
plot(fs.controls[[6]], 
     c("Pacific Blue-A", "PI (B)-A"), 
     xlim = c(0,50000), 
     ylim = c(0,50000), 
     las = 1,
     smooth = FALSE)

plot(fs.controls[[7]], 
     c("Pacific Blue-A", "PI (B)-A"), 
     xlim = c(0,50000), 
     ylim = c(0,50000), 
     las = 1,
     smooth = FALSE)
```

## 2.2 Preprocessing
### 2.2.1 Compensation
```{r}
fs.controls[[1]]@description$'SPILL'

fs.controls.comp <- fsApply(fs.controls,function(frame){
  #extract compensation matrix from keywords
  comp <- keyword(frame)$`SPILL`
  new_frame <- compensate(frame,comp)
  new_frame
})

fs.controls.comp
summary(fs.controls.comp)
```

### 2.2.2 Visualize and Remove Margin events

=> write function for calculating margin events based on data

```{r}
# Evaluate need for transformation
par(mfrow = c(1,1), mar = c(5,6,4,1))
plot(fs.controls[[6]][1:10000,], 
     c("FSC PMT-A", "SSC-A"), 
     xlim = c(0,200000), 
     ylim = c(0,50000), 
     las =1,
     main = "unstained E. coli",
     smooth = FALSE)

# Static cutoff
abline(v = 150000, col = "blue", lwd = 3, lty = "dashed")

# dynamic cutoff

# First, select the margin events
margin.cells <- which(exprs(fs.controls[[1]])[,"FSC PMT-A"] >= 250000)
length(margin.cells)
nrow(fs.controls[[6]])

# Calculate the percentage of cells on the FSC-A margin:
margin.perc <- 100 * length(margin.cells)/nrow(fs.controls[[6]])
margin.perc

# Visualize margin events

A <- exprs(fs.controls[[6]])[,c("FSC PMT-A", "SSC-A")]

points(A[margin.cells,], pch = ".", col = "red", cex = 3)
legend('top', legend = paste("Margin Events:",round(margin.perc, digits = 4), "%"),
       col = "red", pch = 19)

f.clean.margin <- fs.controls[[6]][-margin.cells]
nrow(f.clean.margin)

```

### 2.2.3 Transformation
```{r}
vals <- exprs(f.clean.margin)[,"R780-A"]
vals[1:4]

# Set up plot region

par(mfrow = c(2,2), mar = c(3,3,3,1), mgp = c(2,1,0))
plot(density(vals), 
     xlim = c(0,20000),
     main = "Untransformed CD3 values")
plot(density(log10(vals), na.rm = TRUE), main = "Log Transform")
plot(density(asinh(vals)), main = "Asinh")
plot(density(lgcl(vals)), main = "Logicle")
```

## 3. QC checks on data
```{r}
```

## 4. Define dynmanic gates using flowDensity
```{r}
# Create a gate for each single, double, or triple color control as well as beads
# background

# beads

# Live/Dead gating with the 

# Active/Dormant gating with Hoescht 33342 and Pyronin-Y staining
```

## 5. Calculate populations of active, dormant, and dead cells

**Active** populations are cells that have RNA > DNA
**Dormant** population have RNA = DNA
**Dead** population is filtered out with the fixed viability dye